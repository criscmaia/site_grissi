<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>√Årvore Geneal√≥gica - Fam√≠lia Grizzo . Grice . Gris . Grissi</title>

    <link rel="stylesheet" type="text/css" href="index.css" />
    <link href='https://cdnjs.cloudflare.com/ajax/libs/normalize/4.1.1/normalize.min.css' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="js/modern-search.css" />

    <!-- Google Analytics -->
    <script>
        window.ga = window.ga || function() {
            (ga.q = ga.q || []).push(arguments)
        };
        ga.l = +new Date;
        ga('create', 'UA-80216670-1', 'auto');
        ga('require', 'linkid');
        ga('send', 'pageview');
    </script>
    <script async src='https://www.google-analytics.com/analytics.js'></script>
    <!-- End Google Analytics -->
</head>

<body>
    <!-- mobile code -->
    <div class="mobile">
        <div id="mobile-titulo"><span>Fam√≠lia Grizzo . Grice . Gris . Grissi</span></div>
        <div id="mobile-subtitulo"><span>Uma fam√≠lia originalmente italiana</span></div>
        <div id="mobile-centralizarmenu">
            <div id="navcontainer">
                <ul id="navlist">
                    <li>|<a href="./"> P√°gina Principal</a> |</li>
                    <li><a href="./arvore-genealogica.html" id="current"> √Årvore Geneal√≥gica</a> |</li>
                    <li><a href="./historia.html"> Hist√≥ria</a> |</li>
                    <li><a href="./lembrancas.html"> Lembran√ßas</a> |</li>
                    <li><a href="./fotos.html"> Fotos</a> |</li>
                    <li><a href="./contato.html"> Contato</a> |</li>
                </ul>
            </div>
        </div>

        <div id="intro">
            <div id="arvore-content">
                <!-- The genealogy tree content will be loaded here -->
            </div>
        </div>
        <div id="rodape" class="legenda">
            <p align="center">¬© <a href="mailto:criscmaia@gmail.com?Subject=Fam√≠lia Grizzo%20.%20Grice%20.%20Gris%20.%20Grissi">Cristiano Maia</a> - 2004-<script>document.write(new Date().getFullYear())</script></p>
        </div>
    </div>

    <script>
        /**
         * Modern Genealogy Tree Application - Phase 1 & 2 Optimizations
         * Features:
         * - Photo manifest system (eliminates 120+ HTTP requests)
         * - Modular ES6 architecture
         * - Enhanced error handling
         * - Modern JavaScript features
         * - Optimized DOM operations
         */
        
        // Global application state
        let genealogyManager = null;
        
        /**
         * Initialize the application with modern features
         */
        async function initializeApplication() {
            try {
                console.log('üöÄ Initializing Modern Genealogy Application');
                
                // Show loading state
                const contentElement = document.getElementById('arvore-content');
                if (contentElement) {
                    contentElement.classList.add('genealogy-loading');
                    console.log('üîÑ Loading state added');
                }
                
                // Initialize the genealogy manager
                if (window.GenealogyManager) {
                    console.log('‚úÖ Using new GenealogyManager');
                    genealogyManager = new window.GenealogyManager();
                } else {
                    console.warn('‚ö†Ô∏è GenealogyManager not found, will fallback');
                    throw new Error('GenealogyManager not available');
                }
                
                // Load and process the genealogy tree
                await genealogyManager.loadGenealogyTree();
                
                // Initialize search engine (enhanced version)
                initializeSearchEngine();
                
                // Remove loading state
                if (contentElement) {
                    contentElement.classList.remove('genealogy-loading');
                    console.log('‚úÖ Loading state removed');
                }
                
                // Log statistics
                const stats = genealogyManager.getStatistics();
                console.log('üìä Application loaded successfully:', stats);
                
            } catch (error) {
                console.error('‚ùå Failed to initialize application:', error);
                
                // Ensure loading state is removed even on error
                const contentElement = document.getElementById('arvore-content');
                if (contentElement) {
                    contentElement.classList.remove('genealogy-loading');
                    console.log('üîÑ Loading state removed (error fallback)');
                }
                
                // Fallback to basic functionality
                await fallbackInitialization();
            }
        }
        
        /**
         * Initialize the enhanced search engine
         */
        function initializeSearchEngine() {
            try {
                // Use new ModernSearchEngine if available, fallback to original
                const SearchClass = window.ModernSearchEngine || window.ModernSearch;
                
                if (SearchClass) {
                    new SearchClass();
                    console.log('üîç Enhanced search engine initialized');
                } else {
                    console.warn('‚ö†Ô∏è No search engine available');
                }
            } catch (error) {
                console.error('‚ùå Search engine initialization failed:', error);
            }
        }
        
        /**
         * Fallback initialization for backward compatibility
         */
        async function fallbackInitialization() {
            console.log('üîÑ Using fallback initialization');
            
            try {
                // Load content the old way
                const response = await fetch('./arvore.html');
                const data = await response.text();
                document.getElementById('arvore-content').innerHTML = data;
                
                // Initialize basic search
                if (window.ModernSearch) {
                    new window.ModernSearch();
                }
                
                console.log('‚úÖ Fallback initialization completed');
                
            } catch (error) {
                console.error('‚ùå Fallback initialization failed:', error);
                document.getElementById('arvore-content').innerHTML = 
                    '<p>Erro ao carregar a √°rvore geneal√≥gica. Tente recarregar a p√°gina.</p>';
            }
        }
        
        /**
         * Handle application errors gracefully
         */
        window.addEventListener('error', (event) => {
            console.error('üö® Global error:', event.error);
            
            // Don't break the application for minor errors
            if (!event.error?.message?.includes('genealogy')) {
                event.preventDefault();
            }
        });
        
        /**
         * Handle unhandled promise rejections
         */
        window.addEventListener('unhandledrejection', (event) => {
            console.error('üö® Unhandled promise rejection:', event.reason);
            
            // Prevent the default handling (which logs to console)
            event.preventDefault();
        });
        
        /**
         * Main application entry point
         */
        document.addEventListener('DOMContentLoaded', async () => {
            // Add performance timing
            const startTime = performance.now();
            
            // Safety timeout to remove loading state after 10 seconds max
            const safetyTimeout = setTimeout(() => {
                const contentElement = document.getElementById('arvore-content');
                if (contentElement && contentElement.classList.contains('genealogy-loading')) {
                    contentElement.classList.remove('genealogy-loading');
                    console.warn('‚ö†Ô∏è Loading state removed by safety timeout');
                }
            }, 10000);
            
            try {
                await initializeApplication();
                
                const endTime = performance.now();
                console.log(`‚ö° Application initialized in ${Math.round(endTime - startTime)}ms`);
                
            } catch (error) {
                console.error('‚ùå Application initialization failed:', error);
            } finally {
                // Clear the safety timeout
                clearTimeout(safetyTimeout);
            }
        });
    </script>
    
    <!-- Modern Modular Scripts -->
    <script src="js/photo-handler.js"></script>
    <script src="js/genealogy-manager.js"></script>
    <script src="js/modern-search-engine.js"></script>
    
    <!-- Fallback: Original Search Script for compatibility -->
    <script src="js/modern-search.js"></script>
</body>
</html> 