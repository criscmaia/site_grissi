name: Upload Photo from Website

# This allows the workflow to be triggered by an API call
on:
  workflow_dispatch:
    inputs:
      password:
        description: 'Admin password for upload'
        required: true
      filename:
        description: 'The name of the file to upload'
        required: true
      file_content_base64:
        description: 'The Base64-encoded content of the file'
        required: true
      person_id:
        description: 'ID of the person this photo belongs to'
        required: false
      person_name:
        description: 'Name of the person this photo belongs to'
        required: false

jobs:
  upload:
    runs-on: ubuntu-latest

    steps:
      - name: 'üîí Check Password'
        if: ${{ github.event.inputs.password != secrets.ADMIN_PASSWORD }}
        run: |
          echo "‚ùå Incorrect password."
          exit 1 # This will stop the workflow immediately

      - name: '‚úÖ Password OK! Checkout repository'
        uses: actions/checkout@v4
        with:
          # We need to use the PAT here to be able to push back to the repo
          token: ${{ secrets.GRISSI_TOKEN_PAT }}

      - name: '‚úçÔ∏è Decode and Write File'
        run: |
          # The path where you want to save the images
          mkdir -p images/arvore
          
          # Handle duplicate filenames by adding a timestamp suffix if file exists
          filename="${{ github.event.inputs.filename }}"
          base_name="${filename%.*}"
          extension="${filename##*.}"
          final_filename="$filename"
          
          # If file exists, add timestamp to make it unique
          if [ -f "images/arvore/$filename" ]; then
            timestamp=$(date +"%Y%m%d_%H%M%S")
            final_filename="${base_name}_${timestamp}.${extension}"
            echo "File exists, renaming to: $final_filename"
          fi
          
          # Decode the Base64 content and write it to the file
          echo "${{ github.event.inputs.file_content_base64 }}" | base64 --decode > "images/arvore/$final_filename"
          
          # Store the final filename for the commit message
          echo "FINAL_FILENAME=$final_filename" >> $GITHUB_ENV

      - name: 'üöÄ Commit and Push File'
        run: |
          git config --global user.name "Image Uploader Bot"
          git config --global user.email "bot@users.noreply.github.com"
          git add "images/arvore/$FINAL_FILENAME"
          
          # Create commit message with person info if provided
          if [ -n "${{ github.event.inputs.person_name }}" ]; then
            commit_msg="üñºÔ∏è Add photo for ${{ github.event.inputs.person_name }}: $FINAL_FILENAME"
          else
            commit_msg="üñºÔ∏è Add new image: $FINAL_FILENAME"
          fi
          
          # Check if there are changes to commit
          if ! git diff-index --quiet HEAD; then
            git commit -m "$commit_msg"
            git push
            echo "‚úÖ Successfully uploaded: $FINAL_FILENAME"
          else
            echo "No changes to commit."
          fi